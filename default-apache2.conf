#P1
#Crear claves ssh y configurarlas con contraseña/publicKey o para que los roots no entren directamente (tanto desde la máquina como desde el editor de la mv)
#
#Crear clave:
#ssh-keygen -t rsa -b 4096 -f ubuntu-brr746.pem -C "ubuntu"
#
#Copiar clave publica en /.ssh/authorized_keys
#sudo nano /.ssh/authorized_keys
#
#Dar permisos 
#sudo chown ubuntu:ubuntu /home/ubuntu/.ssh
#sudo chmod 700 /home/ubuntu/.ssh
#sudo chmod 600 /home/ubuntu/.ssh/authorized_keys
#
#Para contraseña cambiar:
#
#sudo nano /etc/ssh/sshd_config 
#PubkeyAuthentication no
#PasswordAuthentication yes
#
#sudo nano /etc/ssh/sshd_config.d/*.conf
#	PasswordAuthentication yes
#
#Crear usuarios:
#sudo useradd -m profesor-A (el -m es MUY IMPORTANTE PARA QUE TE CREE SU CARPETA PERSONAL)
#
#Ponerles contraseña:
#sudo passwd profesor-A
#
#Asignar permisos:
#	chgrp asigna grupos a una carpeta con sudo chgrp profesores /opt/privado
#	sudo chgrp estudiantes /opt/publico
#sudo chmod  770 /ruta a la carpeta (la primera posicion es el root, la segunda el grupo y la tercera los demás grupos o usuarios. 770 por ejemplo da rwx a root y al grupo el que se le haya asignado al usuario y ningun permiso al resto)
#
#Añadir usuario a grupos:
#sudo adduser profesor-A profesores (sudo adduser “nombredelusuario” “nombredelgrupo”)
#(Para que los usuarios que se creen a partir de este momento que quieras tener con directorios automaticos creados dentro de su carpeta hay que editar el /etc/skel, si añades directorios o archivos ahí, cuando se cree un usuario tendrá todo lo que haya en esa carpeta)
#
#Configurar/instalar/editar puertos de shellinabox
#sudo apt install shellinabox -y
#sudo nano /etc/defaults/shellinabox (dentro cambiar el puerto al que se pida y añadir despues del –no-beep --disable-ssl)
#
#Para parar shellinabox:
sudo systemctl stop shellinabox 
#Ten en cuenta que habrá que habilitar el puerto necesario en las firewalls de gcloud.
#
#Cron
#sudo apt update 
#sudo apt install cron -y 
#sudo systemctl enable cron
#sudo systemctl start cron
#Para programar un script:
#sudo crontab -e 
#* * * * * ruta/del/archivo.sh (minuto hora dia_mes mes dia_semana)
#
#/sbin/shutdown -h now 
#Cambiar zona horaria
#timedatectl 
#sudo timedatectl set-timezone Europe/Madrid
#Programar desde fuera que tu máquina se apague (schedule)
#
#P2 
#Instalar entorno LAMP(apache, Mysql, Php) y crear una pag web (/var/www/html)
#sudo apt update 
#sudo apt install apache2 -y
#wget https://dev.mysql.com/get/mysql-apt-config_0.8.29-1_all.deb
#sudo dpkg -i mysql-apt-config_0.8.29-1_all.deb
#sudo apt update 
#sudo apt install mysql-server -y
#sudo mysql_secure_installation
#sudo apt install php libapache2-mod-php php-mysql -y
#
#sudo nano phpinfo.php

<?php
phpinfo();
¿>

#Para que te interprete php con apache
#sudo apt install libapache2-mod-php -y
#
#Crear snapshots del disco y crear imagen de esa snapshot o de la propia mv
#Crear disco, formatearlo y montarlo (auto). Redimensionar disco desde fuera y dentro. Particionarlo y montar RAID
#
#lsblk
#
#Particionar:
#	sudo fdisk /dev/sdb
#
#Crear el raid:
#	sudo mdadm --create /dev/md0 --level=10 --raid-devices=4 /dev/sdb1 /dev/sdb2 /dev/sdb3 /dev/sdb4
#
#Consultar progreso:
#	cat /proc/mdstat
#
#Construir el sistema de archivos:
# sudo mkfs -t ext4 /dev/md0
#
#Escribir la linea en el /etc/fstab consultando el UUID (sudo blkid /dev/md0):
# UUID=ae8e5116-3394-4a8d-a3df-6a550d4cd13d /var/www/html ext4 defaults,nofail 0 2
#
#Montar automáticamente:
#	sudo mount -a
#Para que phpinfo.php e index.html se vean en función al raid, debes montarlo en el directorio donde deben estar los archivos, pero esos archivos deben estar en ese directorio luego de montar el raid, no antes. Si no se sobreescribe.
#Saber entrar a la cli con  credenciales o instalarlo (script que te entre a cli y te cree una mv y haga cosas en general )
#
#P3 
#Chequear el espacio disponible del disco
#df -h 
#hacer update y upgrade
#Como saber a donde pertenece X paquete y si es corrupto, reinstalación
#Crear grupos y directorios privados asignando permisos
#Crear grupo
#sudo groupadd Nombre_Grupo
#
#Asignar directorio /opt/privado /opt/publico a profesores
#sudo chgrp profesores /opt/privado /opt/publico (hace que el grupo profesores sea el dueño de esos directorios)
#
#Permisos
#sudo chmod 770 /opt/privado Los usuarios del grupo profesores RWX
#sudo chmod 775 /opt/publico Los usuarios del grupo profesores RWX y otros RW
#
#
#cuotas para grupos y saber gestionarlas
#sudo apt update
#sudo apt install -y linux-modules-extra-$(uname -r)
#sudo apt install quota quotatool - y 
#
#sudo nano /etc/fstab 
#(buscar la línea del directorio raíz / y escribir  ) 
#discard,errors=remount-ro,usrquota,grpquota
#sudo mount -o remount / 
#sudo quotaoff -vg /
#sudo quotacheck -cugm /
#sudo quotaon -vg / 
#sudo setquota -g estudiantes 450000 500000 0 0 /
#sudo repquota -gv /
#
#
#Instalar shellinabox 
#sudo apt install shellinabox
#sudo systemctl status/restart shellinabox
#
#Cambiar ssl o puertos
#sudo nano /etc/default/shellinabox 
# –disable-ssl”
#(así puedes hacer uso del http)
#
#Configurar directorios predeterminados 
#sudo mkdir -p /etc/skel/directorio_por_defecto
#sudo chown -R root:root /etc/skel
#sudo chmod 755 /etc/skel/directorio_por_defecto
#
#Hacer que un directorio sea de un grupo y todos los archivos que crees dentro:
#chgrp estudiantes /opt/publico
#chmod g+s /opt/publico
#Dar permisos de admin a grupos
#sudo visudo 
#%grupo ALL=(ALL:ALL) ALL
#El % es de grupo 
#ALL= todos los hosts
#(ALL:ALL)= (usuarios:grupos)
#ALL = comandos
#
#umask
#
#Partición linux y lvm
#Suponiendo que tenemos un volumen para la lvm 
#LVM:
#sudo parted -s /dev/sdb mklabel gpt
#sudo parted -s /dev/sdb mkpart primary 0% 100%
#sudo parted -s /dev/sdb set 1 lvm on
#//////////Tambien se puede hacer con fdisk/////////////////
#sudo fdisk /dev/sdb
#g 
#n  
#1 
#Enter
#Tamaño que quieras
#t 
#31
#w
#sudo partprobe /dev/sdb
#
#sudo pvcreate /dev/sdb1
#sudo vgcreate vg_login /dev/sdb1
#sudo lvcreate -l 100%FREE -n lv_datos vg_login
#
#sudo mkfs -t ext4 -F -L vol_cs2 /dev/vg_login/lv_datos
#sudo mkdir -p /mnt/vol_cs2
#sudo mount -L vol_cs2 /mnt/vol_cs2
#
#echo "LABEL=vol_cs2 /mnt/vol_cs2 ext4 defaults,nofail 0 2" | sudo tee -a /etc/fstab
#
#LINUX:
#sudo fdisk /dev/sdb
#n 
#p
#1
#Enter
#Tamaño (+5G)
#w
#sudo partprobe /dev/sdb
#
#sudo mkfs -t ext4 -L vol_linux /dev/sdb2
#sudo mkdir -p /mnt/vol_linux
#sudo mount -L vol_linux /mnt/vol_linux
#sudo nano /etc/fstab
#LABEL=vol_linux /mnt/vol_linux ext4 defaults,nofail 0 2
#
#Script que sepa hacer copias de seguridad y que elimine las copias más antiguas. Todo a una hora determinada
#	
#	sudo apt install cron -y 
#	sudo crontab -e (elegir 1)
#* * * * * /ruta/archivo/script.sh >> /var/log/copia_backup.log 2>&1 (añade esta parte para ver si se está ejecutando correctamente)
#
#	Luego puedes hacer: sudo cat /var/log/copia_backup.log 
#	Y así ver posibles errores
#	
#	chmod +x script.sh
#
#	SCRIPT COPIAS SEGURIDAD ELIMINANDO LAS MÁS ANTIGUAS:
#	#!/bin/bash
#
## === CONFIGURACIÓN ===
#LOGIN="brr746"      # <-- Sustituir por tu identificador
#ORIGEN="/home"
#DESTINOS=("/mnt/vol_cs1" "/mnt/vol_cs2")
#FECHA=$(date +"%d_%m_%Y_%H_%M")
#NOMBRE="copia-$LOGIN-$FECHA.tar.gz"
#RUTA_TMP="/tmp/$NOMBRE"
#MIN_LIBRE_MB=200     # Espacio mínimo que debe quedar libre en cada volumen
#
## === CREAR LA COPIA DE SEGURIDAD ===
#echo "[INFO] Generando copia de seguridad..."
#tar -czf "$RUTA_TMP" "$ORIGEN"
#
## === PROCESAR CADA VOLUMEN ===
#for DESTINO in "${DESTINOS[@]}"; do
#
#    echo "[INFO] Procesando volumen: $DESTINO"
#
#    # Crear directorio si no existe
#    mkdir -p "$DESTINO"
#
#    # Comprobar espacio libre en MB
#    LIBRE=$(df -m "$DESTINO" | awk 'NR==2 {print $4}')
#
#    echo "[INFO] Espacio libre antes: ${LIBRE}MB"
#
#    # Mientras no haya espacio suficiente, borrar la copia más antigua
#    while [ "$LIBRE" -lt "$MIN_LIBRE_MB" ]; do
#        MAS_ANTIGUA=$(ls -1t "$DESTINO" | grep "copia-$LOGIN" | tail -n 1)
#
#        if [ -z "$MAS_ANTIGUA" ]; then
#            echo "[WARN] No quedan copias antiguas para borrar."
#            break
#        fi
#
#        echo "[INFO] Borrando copia antigua: $MAS_ANTIGUA"
#        rm -f "$DESTINO/$MAS_ANTIGUA"
#
#        # Recalcular espacio
#        LIBRE=$(df -m "$DESTINO" | awk 'NR==2 {print $4}')
#        echo "[INFO] Espacio libre ahora: ${LIBRE}MB"
#    done
#
#    # Copiar nueva copia de seguridad
#    echo "[INFO] Copiando nueva copia a $DESTINO ..."
#    cp "$RUTA_TMP" "$DESTINO"
#
#done
#
## Eliminar copia temporal
#rm -f "$RUTA_TMP"
#
#echo "[INFO] Copia completada correctamente."
#
#
#	
#Mover un archivo de tu local a tu máquina
#scp /ruta/archivo/local ubuntu@IP_PUBLICA /ruta/archivo/mv
#
#Instalar OpenVPN usando X puerto
#
#	
#
#Intercambiar volumen
#RAID5 persistente
#sudo apt install mdadm -y 
#Una vez tienes los discos vinculados a la mv:
#sudo mdadm –create –verbose /dev/mda0 –level=5 –raid-devices= /dev/sdb /dev/sdc /dev/sdd
#
#Para ver el proceso 
#watch -n 1 cat /proc/mdstat
#
#sudo mkfs -t ex4 /dev/md0
#sudo mkdir -p /mnt/raid5
#sudo mount /dev/md0 /mnt/raid5
#Montar permanente:
#sudo blkid /dev/md0
#sudo nano /etc/fstab
#UUID=ID /dev/md0 ext4 discard,defaults,nofail 0 2 
#
#Para cambiar archivos de un directorio a otro 
#scp /directorio/origen /directorio/destino
#P4
#Saber crear redes con sus subredes y quitarles el acceso a internet 
#Crear Mikrotik (reenvío de Ips): JIJI 
#mv nombre.img disk.raw
#tar -Sczf nombre.img.tar.gz disk.raw
#Crear bucket> subir archivo > nombre.img.tar.gz
#Crear imagen-mikrotik > archivoGCP >Explorar > Bucket > nombre.tar.gz
#Antes de crear, asignarle 2 interfaces una con el acceso a red y otra sin, además activar Reenvío de IP.
#
#
#asignar contraseña a usuario
#Entrar por ssh admin@IP_PUBLICA
#actualizar versión
#/system package update check-for-updates
#/system package update install 
#
#cambiar MTU
#/interface set ethernet1 mtu=VALOR 
#configurar DNS
#/ip dns set servers=8.8.8.8,8.8.4.4
#/ip dns set allow-remote-requests=yes
#Configurar red mediante IP Adresses, Routes y Firewall, Masquerade permitir tráfico saliente 
#Para cada red que tenemos conectada sin acceso a internet (las que no son por defecto de gcp, sino nuestras) hay que:
#crear una ip address:
#
#/ip address add address=direccion_Interna(mikrotik interfaz la que sea)/32 network=gateway(0.1) interface=interfaz_correspondiente
#
#Luego debemos crear la ruta para identifique como llegar a esa ruta:
#/ip route add dst-address=dir_red(.0.0)/24 gateway=dir_red.(0.1)
#-Habilitar ARP en todas las redes, ejemplo:
#
#/interface ethernet set ether1 arp=enabled
#
#Cambiar rutas predeterminadas de gcloud para dar acceso a internet y cambiar puertas de enlace.
#Para dar acceso a internet a una red que no tiene mediante otra debemos crear una srcnat, esto es una nat que cambia la ip privada de la red que no tiene internet a una ip de la red que sí tiene internet para que pueda salir al exterior sin problemas.
#/ip firewall nat add chain=srcnat action=masquerade out-interface=ether1
#
#Además debemos crear una ruta en gcloud, que vaya desde mv(sin internet)-internet
#Es decir: red= red-sin-internet direcciones de destino= 0.0.0.0/0 sig.salto=ip-mikrotik(red-sin-internet)
#
#Para hacer que el cliente pueda conectarse por ssh a servidor (mv sin internet)
#Debemos crear una ruta gcloud de la net1 (red con internet) a ip de destino Dire_IP_red_no_internet/24 cuyo siguiente salto sea el de mikrotik.
#
#Editar fichero de una vm para que el timeout sea X en /etc/systemd/system/network-online.targets.wants/networking.service
#.
#Saber cambiar de puertos la web de mikrotik y saber redireccionar otros para que se vea algo de otra de las máquinas a las que está conectada a mikrotik
#
#Para hacer que la pagina web de una mv de nuestra red se vea por el puerto 80 de mikrotik o cualquiera, debemos usar una dstnat. Esto convierte la ip que llega desde internet a una de la red internet, lo que hace es redirigir las peticiones que llegan desde fuera a la red interna sin internet dandoles una ip privada.
#/ip firewall nat add chain=dstnat protocol=tcp dst-port=80 in-interface=ether1 action=dst-nat to-addresses=(ip-privada-que-contiene-la-página-web(mvservidor)) to-ports=80 comment="Port forward HTTP to net2"
#
#(a qué puerto quieres que le lleguen las peticiones)
#¡IMPORTANTE! Habilitar puerto 80 tanto en mikrotik como en mv sin internet
#
#
#HABILITAR PUERTO 80 Y 443 EN LAS FIREWALLS DE GC (O LOS PUERTOS QUE SE PIDAN) DEJAR CORRIENDO EN EL 80 EL APACHE, PARA ELLO INSTALAR APACHE2 EN SERVIDOR Y HACER EL DSTNAT EN MIKROTIK:
#
#
#LUEGO PARA PONER MIKROTIK EN EL PUERTO 443 SIN CERTIFICADO POR PROTOCOLO HTTP:
#
#/ip service set www port=443
#P5
#Analizar puertos TCP y UDP desde una mv de gcloud como desde tu local
#sudo apt install nmap 
#nmap -sT IP_MV
#nmap -SU IP_MV
#Restringir  acceso de ips a las mvs desde un puerto
#dar acceso a internet a una windows a través de mikrotik
#Restringir ancho de banda del yt de windows a través de mikrotik
#Zona desmilitarizada (realmente solo hay que configurar las firewalls en mikrotik)
#
# 0	;;; Allow established input
#  	chain=input action=accept connection-state=established,related
#
# 1	;;; Allow management from NET1
#  	chain=input action=accept in-interface=ether1
#
# 2	;;; Allow management from NET2
#  	chain=input action=accept in-interface=ether2
#
# 3	;;; Allow management from NET3
#  	chain=input action=accept in-interface=ether3
#
# 4	;;; Allow established/related connections
#  	chain=forward action=accept connection-state=established,related
#
# 5	;;; net1 -> net2 HTTP only
#  	chain=forward action=accept protocol=tcp in-interface=ether1 out-interface=ether2
#  	dst-port=80
#
# 6	;;; net3 -> net2 HTTP only
#  	chain=forward action=accept protocol=tcp in-interface=ether3 out-interface=ether2
#  	dst-port=80
#
# 7	;;; BLOCK net2 -> net3 (total isolation)
#  	chain=forward action=drop in-interface=ether2 out-interface=ether3
#
# 8	;;; net3 -> Internet HTTP/HTTPS only
#  	chain=forward action=accept protocol=tcp in-interface=ether3 out-interface=ether1
#  	dst-port=80,443
#
# 9	;;; net2 -> Internet full access
#  	chain=forward action=accept in-interface=ether2 out-interface=ether1
#
#10	;;; net1 -> net3 full access
#  	chain=forward action=accept in-interface=ether1 out-interface=ether3
#
#11	;;; DROP all other traffic
#  	chain=forward action=drop
#
#PARA CREARLAS:
#
## INPUT CHAIN
#/ip firewall filter add chain=input action=accept connection-state=established,related comment="Allow established input"
#/ip firewall filter add chain=input action=accept in-interface=ether1 comment="Allow management from NET1"
#/ip firewall filter add chain=input action=accept in-interface=ether2 comment="Allow management from NET2"
#/ip firewall filter add chain=input action=accept in-interface=ether3 comment="Allow management from NET3"
#
## FORWARD CHAIN
#/ip firewall filter add chain=forward action=accept connection-state=established,related comment="Allow established/related connections"
#/ip firewall filter add chain=forward action=accept protocol=tcp in-interface=ether1 out-interface=ether2 dst-port=80 comment="net1 -> net2 HTTP only"
#/ip firewall filter add chain=forward action=accept protocol=tcp in-interface=ether3 out-interface=ether2 dst-port=80 comment="net3 -> net2 HTTP only"
#/ip firewall filter add chain=forward action=drop in-interface=ether2 out-interface=ether3 comment="BLOCK net2 -> net3 (total isolation)"
#/ip firewall filter add chain=forward action=accept protocol=tcp in-interface=ether3 out-interface=ether1 dst-port=80,443 comment="net3 -> Internet HTTP/HTTPS only"
#/ip firewall filter add chain=forward action=accept in-interface=ether2 out-interface=ether1 comment="net2 -> Internet full access"
#/ip firewall filter add chain=forward action=accept in-interface=ether1 out-interface=ether3 comment="net1 -> net3 full access"
#/ip firewall filter add chain=forward action=drop comment="DROP all other traffic"
#
#P6
#Crear red en modo personalizado
#Configuración DNS de redes
#Instalar apache2 configurando ssl
#Instalar apache2 -y 
#Verificar con sudo systemctl enable apache2 y sudo systemctl status apache2.
#sudo a2enmod ssl  //Habilita modulo https en apache
#sudo systemctl restart apache2
#sudo systemtcl enable apache2
#sudo mkdir -p /etc/ssl/private //directorio donde guardamos el certificado y la clave
#sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /etc/ssl/private/apache-selfsigned.key -out /etc/ssl/certs/apache-selfsigned.crt
#ES
#Almeria
#Almeria
#UAL
#ARSO
#poner ip externa servidor web
#correoUAL
#sudo cat /etc/ssl/private/apache-selfsigned.key //COPIALO
#sudo cat /etc/ssl/certs/apache-selfsigned.crt //COPIALO
#sudo nano /etc/apache2/sites-available/default-ssl.conf
#CAMBIA ESTO: 
#   SSLCertificateFile      /etc/ssl/certs/apache-selfsigned.crt
#   SSLCertificateKeyFile /etc/ssl/private/apache-selfsigned.key
#sudo a2ensite default-ssl.conf //Habilita un sitio web (el archivo de configuración de ssl)
#sudo systemctl reload apache2
#sudo apache2ctl configtest //Te debe dar OK
#
#Crear plantilla de instancias
#Disco de arranque -> Imagen: imagen-servidorweb
#E2-micro
#Activamos FIrewall HTTP y HTTPS
#
#Crear clúster
#Plantilla: plantilla-servidorweb
#Ubicación: zona Única
#Ajuste de Escala automático -> número de instancias (min, max)= 1 y 5
#	  Autoscaling signals > Editar Indicador: 
#		    Tipo de indicador = Uso de balanceo de cargas de HTTP
#		    Uso de balanceo de carga Objetivo = 80
#Ciclo de Vida de la Instancia de VM
#    Reparación Automática > Verificación de Estado > Crear una verificación de estado:
#    Criterios de buen estado
#        Intervalo de verificación: 10
#        Umbral de mal estado: 3
#		Retraso Inicial = 60
#	Dale a crear
#Te va a salir un aviso de "La configuración del ajuste de escala automático no está completa", dale a Confirm.
#
#Entra y asegurate de que todo lo puesto anteriormente está bien.
#Entramos en edición:
#	Asignación de puertos> Agregar puerto:
#		Nombre: https ; puerto: 443
#
#Aunque te salga aviso en rojo de que no hay backend, seguimos con el balanceador.
#		
#Crear balanceador de carga 
#	1.Balanceador de cargas de aplicaciones (HTTP/HTTPS)
#	2.Orientado al público (externo) 
#	3.Ideal para cargas de trabajo globales 
#	4.Balanceador de cargas de aplicaciones clásico 
#	5. Configurar
#	
#	Ponle nombre al balanceador.
#	Configuración Fronted (HTTP):
#	Primer Frontend:
#		Dirección Ip: reserva una con el nombre de "ip-cluster"
#	Listo
#	Segundo Frontend (HTTPS):
#		Protocolo:HTTPS
#		Dirección IP= ip cluster
#		Certificado > Crear un certificado nuevo:
#			Pega el certificado y la clave que creamos en la MV servidorweb
#		Usar certificado autofirmado
#	
#			
#		
#	Configuración Backend:
#	Servicios y buckets de backend > Crear un servicio de Backend:
#		Protocolo: HTTPS
#		Puerto con nombre: https
#		Verificación de estado: la que hicimos anteriormente
#		Backends > Nuevo Backend:
#			Grupo de Instancias= cluster
#(te va a salir un aviso del puerto, dile que sí. Justo se te debe configurar el puerto 443 que es el que habíamos configurado antes)
#			Listo
#		
#		Deshabilita el "Habilitar Cloud CDN"
#		Cloud Armor = Ninguno
#	Crear (Conf Backend)
#	
#	Crear (Balanceador)
#Para mandar las peticiones y hacer que se creen más mvs en el cluster
#	Crea una nueva MV de prueba 
#export LB_IP=[IP_EXTERNA_BALANCEADOR].
#ab -n 50000 -c 1000 http://$LB_IP/
